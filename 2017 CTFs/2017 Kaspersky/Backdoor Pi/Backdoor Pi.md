# **Backdoor Pi**

#### tag : reversing

--------------------------------------------

#### Description

>We are doing an project for a school competition in which we need to use a Raspberry Pi to make an IOT prototype. We received SD cards from the professor, and because we lost our we asked another group to give us a copy of their card, I know it's been modified because the orginal hash doesn't match. Could you please investigate and tell me if everything is ok? Here is some parts of the file system.

>FLAG FORMAT:KLCTF{flag}

>download this file: https://s3.eu-central-1.amazonaws.com/klctf/fs.zip

--------------------------------------------

#### Challenge

~~~

epist@epist-machine:~/fs$ ls -l
total 84
drwxr-xr-x   2 epist epist 4096 Oct 23 13:29 bin
drwxr-xr-x   2 epist epist 4096 Dec 20  2013 boot
drwxr-xr-x   3 epist epist 4096 Oct 23 13:29 dev
drwxr-xr-x 102 epist epist 4096 Oct 23 13:29 etc
drwxr-xr-x   3 epist epist 4096 Oct 23 13:29 home
drwxr-xr-x   3 epist epist 4096 Oct 23 13:29 lib
drwx------   2 epist epist 4096 Dec 20  2013 lost+found
drwxrwxr-x  13 epist epist 4096 Oct 23 13:29 __MACOSX
drwxr-xr-x   4 epist epist 4096 Oct 23 13:29 media
drwxr-xr-x   2 epist epist 4096 Oct 17  2013 mnt
drwxr-xr-x   3 epist epist 4096 Oct 23 13:29 opt
drwxr-xr-x   2 epist epist 4096 Oct 17  2013 proc
drwx------   4 epist epist 4096 Oct 23 13:29 root
drwxr-xr-x   8 epist epist 4096 Oct 23 13:29 run
drwxr-xr-x   2 epist epist 4096 Oct 23 13:29 sbin
drwxr-xr-x   2 epist epist 4096 Jun 20  2012 selinux
drwxr-xr-x   2 epist epist 4096 Dec 20  2013 srv
drwxr-xr-x   2 epist epist 4096 Oct 13  2013 sys
drwxrwxr-x   4 epist epist 4096 Oct 23 13:29 tmp
drwxr-xr-x  10 epist epist 4096 Oct 23 13:29 usr
drwxr-xr-x  11 epist epist 4096 Oct 23 13:29 var

~~~

I can extract one linux file system from zip downloaded in link.

~~~

./var/spool/cron/crontabs:
total 8
-rw------- 1 epist epist 255 Oct  4 21:41 b4ckd00r_us3r
-rw------- 1 epist epist 255 Oct  4 21:44 pi

~~~

I find some specious file named b4ckd00r_us3r.

~~~

./var/spool/cron/crontabs/b4ckd00r_us3r
# DO NOT EDIT THIS FILE - edit the master and reinstall.
# (/tmp/crontab.80NKS4/crontab installed on Wed Oct  4 19:28:12 2017)
# (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)
# m h  dom mon dow   command
@reboot python /bin/back

~~~

b4ckd00r_us3r run /bin/back after reboot.

~~~

epist@epist-machine:~/fs$ file ./bin/back
./bin/back: python 2.7 byte-compiled

~~~

Let's inspect this file.

~~~

epist@epist-machine:~/fs$ hexdump -C ./bin/back

...
00000100  00 00 74 05 00 00 00 46  6c 61 73 6b 28 01 00 00  |..t....Flask(...|
00000110  00 74 07 00 00 00 72 65  71 75 65 73 74 28 01 00  |.t....request(..|
00000120  00 00 74 05 00 00 00 61  62 6f 72 74 63 02 00 00  |..t....abortc...|
00000130  00 04 00 00 00 04 00 00  00 43 00 00 00 73 6e 00  |.........C...sn.|
00000140  00 00 74 00 00 7c 01 00  83 01 00 64 01 00 6b 01  |..t..|.....d..k.|
00000150  00 72 64 00 7c 01 00 6a  01 00 83 00 00 72 64 00  |.rd.|..j.....rd.|
00000160  64 02 00 6a 02 00 7c 00  00 7c 01 00 83 02 00 7d  |d..j..|..|.....}|
00000170  02 00 74 03 00 6a 04 00  7c 02 00 83 01 00 6a 05  |..t..j..|.....j.|
00000180  00 83 00 00 7d 03 00 7c  03 00 64 03 00 6b 02 00  |....}..|..d..k..|
00000190  72 64 00 64 04 00 6a 02  00 7c 00 00 7c 01 00 83  |rd.d..j..|..|...|
000001a0  02 00 53 6e 00 00 74 06  00 64 05 00 83 01 00 53  |..Sn..t..d.....S|
000001b0  28 06 00 00 00 4e 69 08  00 00 00 73 05 00 00 00  |(....Ni....s....|
000001c0  7b 7d 3a 7b 7d 74 40 00  00 00 33 34 63 30 35 30  |{}:{}t@...34c050|
000001d0  31 35 64 65 34 38 65 66  31 30 33 30 39 39 36 33  |15de48ef10309963|
000001e0  35 34 33 62 34 61 33 34  37 62 35 64 33 64 32 30  |543b4a347b5d3d20|
000001f0  62 62 65 32 65 64 34 36  32 63 66 32 32 36 62 31  |bbe2ed462cf226b1|
00000200  63 63 38 66 66 66 32 32  32 65 73 3c 00 00 00 43  |cc8fff222es<...C|
00000210  6f 6e 67 72 34 74 73 2c  20 79 6f 75 20 66 6f 75  |ongr4ts, you fou|
00000220  6e 64 20 74 68 65 20 62  40 63 6b 64 30 30 72 2e  |nd the b@ckd00r.|
00000230  20 54 68 65 20 66 6c 34  67 20 69 73 20 73 69 6d  | The fl4g is sim|
00000240  70 6c 79 20 3a 20 7b 7d  3a 7b 7d 69 94 01 00 00  |ply : {}:{}i....|
00000250  28 07 00 00 00 74 03 00  00 00 6c 65 6e 74 07 00  |(....t....lent..|
00000260  00 00 69 73 64 69 67 69  74 74 06 00 00 00 66 6f  |..isdigitt....fo|
00000270  72 6d 61 74 74 07 00 00  00 68 61 73 68 6c 69 62  |rmatt....hashlib|
00000280  74 06 00 00 00 73 68 61  32 35 36 74 09 00 00 00  |t....sha256t....|
00000290  68 65 78 64 69 67 65 73  74 52 02 00 00 00 28 04  |hexdigestR....(.|
000002a0  00 00 00 74 04 00 00 00  75 73 65 72 74 07 00 00  |...t....usert...|
000002b0  00 70 69 6e 63 6f 64 65  74 03 00 00 00 76 61 6c  |.pincodet....val|
000002c0  74 03 00 00 00 6b 65 79  28 00 00 00 00 28 00 00  |t....key(....(..|
000002d0  00 00 73 07 00 00 00 62  61 63 6b 2e 70 79 74 0b  |..s....back.pyt.|
000002e0  00 00 00 63 68 65 63 6b  5f 63 72 65 64 73 09 00  |...check_creds..|
000002f0  00 00 73 0c 00 00 00 00  01 1e 01 12 01 15 01 0c  |..s.............|
00000300  01 13 01 74 01 00 00 00  2f 63 00 00 00 00 00 00  |...t..../c......|
00000310  00 00 01 00 00 00 43 00  00 00 73 04 00 00 00 64  |......C...s....d|
00000320  01 00 53 28 02 00 00 00  4e 73 0d 00 00 00 3c 68  |..S(....Ns....<h|
00000330  31 3e 48 4f 4d 45 3c 2f  68 31 3e 28 00 00 00 00  |1>HOME</h1>(....|
00000340  28 00 00 00 00 28 00 00  00 00 28 00 00 00 00 73  |(....(....(....s|
00000350  07 00 00 00 62 61 63 6b  2e 70 79 74 05 00 00 00  |....back.pyt....|
00000360  68 65 6c 6c 6f 13 00 00  00 73 02 00 00 00 00 02  |hello....s......|
00000370  73 09 00 00 00 2f 62 61  63 6b 64 6f 6f 72 63 00  |s..../backdoorc.|
00000380  00 00 00 02 00 00 00 03  00 00 00 43 00 00 00 73  |...........C...s|
00000390  31 00 00 00 74 00 00 6a  01 00 6a 02 00 64 01 00  |1...t..j..j..d..|
...

~~~

In binary, I find specious area where offset is 0x000000200 to 0x00000220.

~~~

Congr4ts, you found the b@ckd00r. The fl4g is simply : {}:{}i

~~~

And I am convinced that I can get flag from this file.

I decompile this pyc by uncompyle6.

~~~

# uncompyle6 version 2.12.0
# Python bytecode 2.7 (62211)
# Decompiled from: Python 2.7.12 (default, Nov 19 2016, 06:48:10)
# [GCC 5.4.0 20160609]
# Embedded file name: back.py
# Compiled at: 2017-10-05 17:09:10
import sys
import os
import time
from flask import Flask
from flask import request
from flask import abort
import hashlib

def check_creds(user, pincode):
    if len(pincode) <= 8 and pincode.isdigit():
        val = '{}:{}'.format(user, pincode)
        key = hashlib.sha256(val).hexdigest()
        if key == '34c05015de48ef10309963543b4a347b5d3d20bbe2ed462cf226b1cc8fff222e':
            return 'Congr4ts, you found the b@ckd00r. The fl4g is simply : {}:{}'.format(user, pincode)
    return abort(404)


app = Flask(__name__)

@app.route('/')
def hello():
    return '<h1>HOME</h1>'


@app.route('/backdoor')
def backdoor():
    user = request.args.get('user')
    pincode = request.args.get('pincode')
    return check_creds(user, pincode)


if __name__ == '__main__':
    app.run(threaded=True, host='0.0.0.0', port=3333)
# okay decompiling back.pyc

~~~

In this code, I can get flag format.

~~~

return 'Congr4ts, you found the b@ckd00r. The fl4g is simply : {}:{}'.format(user, pincode)

~~~

I have to know user and pincode.

~~~

epist@epist-machine:~$ cat ./etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
...
messagebus:x:104:106::/var/run/dbus:/bin/false
usbmux:x:105:46:usbmux daemon,,,:/home/usbmux:/bin/false
lightdm:x:106:109:Light Display Manager:/var/lib/lightdm:/bin/false
avahi:x:107:110:Avahi mDNS daemon,,,:/var/run/avahi-daemon:/bin/false
b4ckd00r_us3r:x:1001:1004::/home/b4ckd00r_us3r:/bin/bash

~~~

I can find user is b4ckd00r_us3r from passwd file.

And I can get pincode by bruteforcing.

--------------------------------------------

#### Solution

**solve.py**

~~~

import sys
import os
import time
import hashlib

user = "b4ckd00r_us3r"

def check_creds(user, pincode):
    if len(pincode) <= 8 and pincode.isdigit():
        val = '{}:{}'.format(user, pincode)
        key = hashlib.sha256(val).hexdigest()
        if key == '34c05015de48ef10309963543b4a347b5d3d20bbe2ed462cf226b1cc8fff222e':
            return 'Congr4ts, you found the b@ckd00r. The fl4g is simply : {}:{}'.format(user, pincode)
	return -1

for x in range(100000000):
    pincode = str(x)
    if(check_creds(user, pincode) != -1):
        print check_creds(user, pincode)
	break;


~~~

~~~

Congr4ts, you found the b@ckd00r. The fl4g is simply : b4ckd00r_us3r:12171337

~~~

**KLCTF{b4ckd00r_us3r:12171337}**
